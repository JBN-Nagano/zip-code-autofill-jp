<!--
  templateType: page
  isAvailableForNewContent: true
  label: 資料ダウンロード（テスト）
  screenshotPath: ../images/template-previews/page-no-header.png
-->
{% extends "./layouts/base.html" %}
{% block header %}
{% global_partial path="../templates/partials/header-2025.html" %}
{% endblock header %}
{% block body %}
{% dnd_area "dnd_area"
  label="Main section",
  class="body-container body-container--page"
%}

{% end_dnd_area %}
<style>
  .hs_toiawasenaiyo_combine {
    display: none;
  }

  /* --- 住所自動入力（ZipCloud）用スタイル --- */
  /* モーダルの背景（オーバーレイ） */
  .zipcloud-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* モーダル本体 */
  .zipcloud-modal {
    background-color: #fff;
    padding: 24px;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    text-align: left;
  }

  /* 見出し */
  .zipcloud-title {
    margin: 0 0 16px 0;
    font-size: 18px;
    text-align: center;
    color: #333;
    font-weight: bold;
  }

  /* 住所選択ボタン */
  .zipcloud-btn {
    display: block;
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    text-align: left;
    font-size: 14px;
    color: #495057;
    transition: background-color 0.2s;
  }

  /* 住所選択ボタン：ホバー時 */
  .zipcloud-btn:hover {
    background-color: #e9ecef;
  }

  /* キャンセルボタン */
  .zipcloud-cancel-btn {
    margin-top: 16px;
    padding: 8px 16px;
    cursor: pointer;
    background-color: transparent;
    color: #666;
    border: none;
    display: block;
    width: 100%;
    text-decoration: underline;
  }

  .zipcloud-cancel-btn:hover {
    color: #333;
  }
</style>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script>
    window.addEventListener('message', event => {

        if(event.data.type === 'hsFormCallback' && event.data.eventName === 'onFormReady') {
            // フォームIDからフォーム要素を特定
            const formId = event.data.id;
            const form = document.querySelector('form[data-form-id="' + formId + '"]');

            // 1. 都道府県（select[name="state"]）に「address-level1」を設定
            $('select[name="state"]').attr('autocomplete', 'address-level1');

            // 2. 住所（input[name="city"]）の属性を「address-line1」に変更
            $('input[name="city"]').attr('autocomplete', 'address-line1');

            $('input[name*=email]').change(function() {
                let emailInput = $('input[name*=email]').val();
                localStorage.setItem('email', emailInput);
            }); //Eメール

            const area1Input = $("input[name*=area1_text]");
            let areadai1kibo = '';
            $(document).on('change', 'select[name^=areadai1kibo_municipalities]', function() {
                console.log("changed");
                areadai1kibo = $('select[name*=areadai1kibo] option:selected').text();
                $('input[name*=area1_text]').val('');
                $('input[name*=area1_text]').val(areadai1kibo);
            });
            const area2Input = $("input[name*=area2_text]");
            let areadai2kibo = '';
            $(document).on('change', 'select[name^=areadai2kibo_municipalities]', function() {
                areadai2kibo = $('select[name*=areadai2kibo] option:selected').text();
                $('input[name*=area2_text]').val('');
                $('input[name*=area2_text]').val(areadai2kibo);
            });
            const area3Input = $("input[name*=area3_text]");
            let areadai3kibo = '';
            $(document).on('change', 'select[name^=areadai3kibo_municipalities]', function() {
                areadai3kibo = $('select[name*=areadai3kibo] option:selected').text();
                $('input[name*=area3_text]').val('');
                $('input[name*=area3_text]').val(areadai3kibo);
            });
            function textarea_combine () {
                var selectedValue = $('input[name="raijyokibo_radio"]:checked').val();
                const toiawasenaiyo2 = $("textarea[name*=toiawasenaiyo2]").val();
                if (selectedValue == "true") {
                    const combined_text = "SR見学希望です\n" + toiawasenaiyo2;
                    $("textarea[name*=toiawasenaiyo_combine]").val(combined_text);
                }
                else {
                    const combined_text = toiawasenaiyo2;
                    $("textarea[name*=toiawasenaiyo_combine]").val(combined_text);
                }
            }
            $("textarea[name*=toiawasenaiyo2]").change(function() {
                textarea_combine();
            });
            $('input[name="raijyokibo_radio"]').change(function() {
                textarea_combine();
            });
            const y = new Date().getFullYear();
            const m = new Date().getMonth() + 1;
            const d = new Date().getDate();
            const w = new Date().getDay();
            const h = new Date().getHours();
            const min = new Date().getMinutes();
            const s = new Date().getSeconds();
            const t = new Date().getTime();
            const renoveru_webid__c = String(y) + String(m) + String(d) + String(w) + String(h) + String(min) + String(s) + String(t);
            sessionStorage.setItem("renoveru_webid__c", renoveru_webid__c);
            $("input[name*=renoveru_webid__c]").val(renoveru_webid__c); //お問い合わせ番号
            $("input[name*=renoveru_webid__c_unix]").val(t); //CAPI用イベントタイム
            $("input[name*=client_user_agent_capi]").val(window.navigator.userAgent); //ユーザーエージェント
            
            // HubSpotフォームの郵便番号フィールドと送信ボタンを取得
            const zipInput = document.querySelector('[name="zip"]');
            const submitButton = document.querySelector('.hs-button.primary.large');

            // フィールドが存在しない場合は終了
            if (!zipInput || !submitButton) return;

            // バリデーション用の正規表現
            // 注意: 入力時にハイフンを除去するため、実質的に7桁の数字のみをチェックします
            const zipRegex = /^\d{7}$/;
            const errorMsgText = "半角7桁の数字のみで入力してください。";

            // エラーメッセージの作成関数
            function createErrorMsg() {
                const ul = document.createElement("ul");
                ul.classList.add("no-list", "hs-error-msgs", "inputs-list");
                ul.setAttribute("role", "alert");

                const li = document.createElement("li");
                const label = document.createElement("label");
                label.classList.add("hs-error-msg", "hs-main-font-element");
                label.textContent = errorMsgText;

                li.appendChild(label);
                ul.appendChild(li);

                return ul;
            }

            // 送信ボタンの状態を更新する関数
            function updateSubmitButtonState() {
                if (zipRegex.test(zipInput.value)) {
                    // 正しい郵便番号の場合、送信ボタンを有効化
                    submitButton.disabled = false;
                } else {
                    // 誤った形式の場合、送信ボタンを無効化
                    submitButton.disabled = true;
                }
            }

            // HubSpotのフィールドに値を設定し、イベントを発火させるヘルパー関数
            // (React/HubSpotが値の変更を検知するために必要)
            function setHubSpotFieldValue(selector, value) {
                const element = document.querySelector(selector);
                if (element) {
                    element.value = value;
                    element.dispatchEvent(new Event('input', { bubbles: true }));
                    element.dispatchEvent(new Event('change', { bubbles: true }));
                    element.dispatchEvent(new Event('blur', { bubbles: true }));
                }
            }

            // 住所候補選択用モーダルを表示する関数
            function showAddressModal(results) {
                // 既にモーダルがあれば削除
                const existingOverlay = document.querySelector('.zipcloud-overlay');
                if (existingOverlay) existingOverlay.remove();

                const overlay = document.createElement('div');
                overlay.className = 'zipcloud-overlay';

                const modal = document.createElement('div');
                modal.className = 'zipcloud-modal';

                const title = document.createElement('h3');
                title.className = 'zipcloud-title';
                title.textContent = '住所を選択してください';
                modal.appendChild(title);

                results.forEach(addr => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'zipcloud-btn';
                    const fullAddr = `${addr.address2}${addr.address3}`;
                    btn.textContent = `${addr.address1} ${fullAddr}`; // 例: 東京都 千代田区千代田
                    
                    btn.addEventListener('click', () => {
                        setHubSpotFieldValue('select[name="state"]', addr.address1); // 都道府県
                        setHubSpotFieldValue('input[name="city"]', fullAddr); // 市区町村以下
                        overlay.remove();
                    });
                    modal.appendChild(btn);
                });

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'zipcloud-cancel-btn';
                cancelBtn.textContent = 'キャンセル';
                cancelBtn.addEventListener('click', () => {
                    overlay.remove();
                });
                modal.appendChild(cancelBtn);

                overlay.appendChild(modal);
                document.body.appendChild(overlay);
            }

            zipInput.addEventListener("input", function (e) {
                // 1. 現在の入力値を取得
                let val = zipInput.value;

                // 2. 全角数字を半角変換、および半角ハイフンの除去を実行（文字などのテキストは残す）
                let normalizedVal = val
                    .replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xfee0))
                    .replace(/-/g, "");

                // 3. 値に変更があった場合のみDOMを更新（カーソル位置飛び防止のため）
                if (val !== normalizedVal) {
                    zipInput.value = normalizedVal;
                    val = normalizedVal; // バリデーション用に変数を更新
                }

                const errorMsgContainer = zipInput.closest(".input").nextElementSibling;

                // バリデーションチェック（正規化済みのため、7桁数字のみチェック）
                if (zipRegex.test(val)) {
                    // --- バリデーション成功 ---
                    zipInput.classList.remove("invalid", "error");
                    zipInput.classList.add("valid");

                    if (errorMsgContainer && errorMsgContainer.classList.contains("hs-error-msgs")) {
                        errorMsgContainer.remove();
                    }

                    // 既に normalizedVal は数字のみになっているのでそのまま使用
                    $.ajax({
                        url: "https://zipcloud.ibsnet.co.jp/api/search",
                        type: "GET",
                        data: { zipcode: val },
                        dataType: "jsonp", // クロスドメイン対策
                        success: function(data) {
                            if (data.results) {
                                if (data.results.length === 1) {
                                    // 候補が1つの場合：直接セット
                                    const result = data.results[0];
                                    const addressRest = result.address2 + result.address3;
                                    setHubSpotFieldValue('select[name="state"]', result.address1);
                                    setHubSpotFieldValue('input[name="city"]', addressRest);
                                } else {
                                    // 候補が複数の場合：モーダル表示
                                    showAddressModal(data.results);
                                }
                            } else {
                                console.log('該当する住所が見つかりませんでした。');
                            }
                        },
                        error: function(err) {
                            console.error('郵便番号検索エラー:', err);
                        }
                    });

                } else {
                    // バリデーション失敗時、エラーメッセージを表示
                    zipInput.classList.remove("valid");
                    zipInput.classList.add("invalid", "error");

                    // エラーメッセージが存在しない場合のみ追加
                    if (!errorMsgContainer || !errorMsgContainer.classList.contains("hs-error-msgs")) {
                        const errorMsg = createErrorMsg();
                        zipInput.closest(".input").insertAdjacentElement("afterend", errorMsg);
                    }
                }

                // 送信ボタンの状態を更新
                updateSubmitButtonState();
            });

            // 初期状態で送信ボタンを無効化
            updateSubmitButtonState();

            // クッキーを取得する関数
            function getCookie(name) {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith(name + "=")) {
                        return cookie.substring(name.length + 1);
                    }
                }
                return null; // クッキーが見つからない場合はnullを返す
            }

            // _fbp と _fbc の値を取得してフォームにセットする
            function setFbpAndFbc() {
                console.log("クッキー情報: ", document.cookie); // クッキーの確認

                let fbp = getCookie("_fbp") || localStorage.getItem("_fbp"); // クッキー or ローカルストレージから取得
                let fbc = getCookie("_fbc") || localStorage.getItem("_fbc");

                console.log("_fbp:", fbp, "_fbc:", fbc); // 値の確認

                // _fbpが取得できない場合は、Facebook Pixelをトリガーして取得を試みる
                if (!fbp && window.fbq) {
                    console.log("fbpが取得できないため、Facebook Pixelを実行");
                    fbq('track', 'PageView'); // 強制的にピクセルイベントをトリガー
                    setTimeout(() => {
                        fbp = getCookie("_fbp");
                        if (fbp) {
                            localStorage.setItem("_fbp", fbp); // ローカルストレージに保存
                        }
                    }, 2000); // 2秒遅延して取得
                }

                // フォーム要素が存在するかチェック
                setTimeout(() => {
                    let fbpInput = document.querySelector("input[name*=browser_id_fbp_capi]");
                    let fbcInput = document.querySelector("input[name*=click_id_fbc_capi]");

                    if (fbp && fbpInput) {
                        fbpInput.value = fbp;
                    }
                    if (fbc && fbcInput) {
                        fbcInput.value = fbc;
                    }
                }, 1000); // 1秒遅延させてフォームのロードを待つ
            }

            // 実行
            setFbpAndFbc();
        }
        if(event.data.type === 'hsFormCallback' && event.data.eventName === 'onFormSubmitted') {
            window.location = '/contacts/document/thanks#application';
        }
    }, false);
</script>
{% endblock body %}
{% block footer %}
{% global_partial path="../templates/partials/footer-2025.html" %}
{% endblock footer %}
