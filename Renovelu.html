{% extends "./layouts/base.html" %}
{% block header %}
{% global_partial path="../templates/partials/header-2025.html" %}
{% endblock header %}
{% block body %}
{% dnd_area "dnd_area"
  label="Main section",
  class="body-container body-container--page"
%}

{% end_dnd_area %}
<style>
  .hs_toiawasenaiyo_combine {
    display: none;
  }

  /* --- 住所自動入力（ZipCloud）用スタイル --- */
  /* モーダルの背景（オーバーレイ） */
  .zipcloud-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* モーダル本体 */
  .zipcloud-modal {
    background-color: #fff;
    padding: 24px;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    text-align: left;
  }

  /* 見出し */
  .zipcloud-title {
    margin: 0 0 16px 0;
    font-size: 18px;
    text-align: center;
    color: #333;
    font-weight: bold;
  }

  /* 住所選択ボタン */
  .zipcloud-btn {
    display: block;
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    text-align: left;
    font-size: 14px;
    color: #495057;
    transition: background-color 0.2s;
  }

  /* 住所選択ボタン：ホバー時 */
  .zipcloud-btn:hover {
    background-color: #e9ecef;
  }

  /* キャンセルボタン */
  .zipcloud-cancel-btn {
    margin-top: 16px;
    padding: 8px 16px;
    cursor: pointer;
    background-color: transparent;
    color: #666;
    border: none;
    display: block;
    width: 100%;
    text-decoration: underline;
  }

  .zipcloud-cancel-btn:hover {
    color: #333;
  }
</style>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script>
    window.addEventListener('message', event => {

        if(event.data.type === 'hsFormCallback' && event.data.eventName === 'onFormReady') {
            // フォームIDからフォーム要素を特定
            const formId = event.data.id;
            const form = document.querySelector('form[data-form-id="' + formId + '"]');

            // 1. 都道府県（select[name="state"]）に「address-level1」を設定
            $('select[name="state"]').attr('autocomplete', 'address-level1');

            // 2. 住所（input[name="city"]）の属性を「address-line1」に変更
            $('input[name="city"]').attr('autocomplete', 'address-line1');

            $('input[name*=email]').change(function() {
                let emailInput = $('input[name*=email]').val();
                localStorage.setItem('email', emailInput);
            }); //Eメール
            const area1Input = $("input[name*=area1_text]");
            let areadai1kibo = '';
            $(document).on('change', 'select[name^=areadai1kibo_municipalities]', function() {
                console.log("changed");
                areadai1kibo = $('select[name*=areadai1kibo] option:selected').text();
                $('input[name*=area1_text]').val('');
                $('input[name*=area1_text]').val(areadai1kibo);
            });
            const area2Input = $("input[name*=area2_text]");
            let areadai2kibo = '';
            $(document).on('change', 'select[name^=areadai2kibo_municipalities]', function() {
                areadai2kibo = $('select[name*=areadai2kibo] option:selected').text();
                $('input[name*=area2_text]').val('');
                $('input[name*=area2_text]').val(areadai2kibo);
            });
            const area3Input = $("input[name*=area3_text]");
            let areadai3kibo = '';
            $(document).on('change', 'select[name^=areadai3kibo_municipalities]', function() {
                areadai3kibo = $('select[name*=areadai3kibo] option:selected').text();
                $('input[name*=area3_text]').val('');
                $('input[name*=area3_text]').val(areadai3kibo);
            });
            function textarea_combine () {
                var selectedValue = $('input[name="raijyokibo_radio"]:checked').val();
                const toiawasenaiyo2 = $("textarea[name*=toiawasenaiyo2]").val();
                if (selectedValue == "true") {
                    const combined_text = "SR見学希望です\n" + toiawasenaiyo2;
                    $("textarea[name*=toiawasenaiyo_combine]").val(combined_text);
                }
                else {
                    const combined_text = toiawasenaiyo2;
                    $("textarea[name*=toiawasenaiyo_combine]").val(combined_text);
                }
            }
            $("textarea[name*=toiawasenaiyo2]").change(function() {
                textarea_combine();
            });
            $('input[name="raijyokibo_radio"]').change(function() {
                textarea_combine();
            });
            const y = new Date().getFullYear();
            const m = new Date().getMonth() + 1;
            const d = new Date().getDate();
            const w = new Date().getDay();
            const h = new Date().getHours();
            const min = new Date().getMinutes();
            const s = new Date().getSeconds();
            const t = new Date().getTime();
            const renoveru_webid__c = String(y) + String(m) + String(d) + String(w) + String(h) + String(min) + String(s) + String(t);
            sessionStorage.setItem("renoveru_webid__c", renoveru_webid__c);
            $("input[name*=renoveru_webid__c]").val(renoveru_webid__c); //お問い合わせ番号
            $("input[name*=renoveru_webid__c_unix]").val(t); //CAPI用イベントタイム
            $("input[name*=client_user_agent_capi]").val(window.navigator.userAgent); //ユーザーエージェント
            
            // HubSpotフォームの郵便番号フィールドと送信ボタンを取得
            // 注意: 郵便番号フィールドは後続のZipCloudロジックでも使用しますが、
            // 既存のバリデーションロジックと競合しないようインスタンスを共有または再取得します。
            const zipInput = document.querySelector('[name="zip"]');
            const submitButton = document.querySelector('.hs-button.primary.large');

            // フィールドが存在しない場合は終了
            if (!zipInput || !submitButton) return;

            // バリデーション用の正規表現
            const zipRegex = /^\d{7}$|^\d{3}-\d{4}$/;
            const errorMsgText = "半角7桁の数字のみ、またはハイフン付きの形式（例: 1234567 または 123-4567）で入力してください。";
            console.log("⭐️⭐️⭐️⭐️⭐️zipInput",zipInput)

            // エラーメッセージの作成関数
            function createErrorMsg() {
                const ul = document.createElement("ul");
                ul.classList.add("no-list", "hs-error-msgs", "inputs-list");
                ul.setAttribute("role", "alert");

                const li = document.createElement("li");
                const label = document.createElement("label");
                label.classList.add("hs-error-msg", "hs-main-font-element");
                label.textContent = errorMsgText;

                li.appendChild(label);
                ul.appendChild(li);

                return ul;
            }

            // 送信ボタンの状態を更新する関数
            function updateSubmitButtonState() {
                if (zipRegex.test(zipInput.value)) {
                    // 正しい郵便番号の場合、送信ボタンを有効化
                    submitButton.disabled = false;
                } else {
                    // 誤った形式の場合、送信ボタンを無効化
                    submitButton.disabled = true;
                }
            }

            // 入力時のバリデーションチェック
            zipInput.addEventListener("input", function () {
                const zipValue = zipInput.value;
                const errorMsgContainer = zipInput.closest(".input").nextElementSibling;

                // バリデーションチェック
                if (zipRegex.test(zipValue)) {
                    // バリデーション成功時、エラーメッセージを削除
                    zipInput.classList.remove("invalid", "error");
                    zipInput.classList.add("valid");

                    if (errorMsgContainer && errorMsgContainer.classList.contains("hs-error-msgs")) {
                        errorMsgContainer.remove();
                    }
                } else {
                    // バリデーション失敗時、エラーメッセージを表示
                    zipInput.classList.remove("valid");
                    zipInput.classList.add("invalid", "error");

                    // エラーメッセージが存在しない場合のみ追加
                    if (!errorMsgContainer || !errorMsgContainer.classList.contains("hs-error-msgs")) {
                        const errorMsg = createErrorMsg();
                        zipInput.closest(".input").insertAdjacentElement("afterend", errorMsg);
                    }
                }

                // 送信ボタンの状態を更新
                updateSubmitButtonState();
            });

            // 初期状態で送信ボタンを無効化
            updateSubmitButtonState();
            
            // 【修正箇所】ここに余分な「}」がありましたが削除しました

            // --- ここから追加：ZipCloud APIによる住所自動入力ロジック ---
            if (form) {
                const zipInputForApi = form.querySelector('input[name="zip"]');
                const stateInput = form.querySelector('select[name="state"]') || form.querySelector('input[name="state"]');
                const cityInput = form.querySelector('input[name="city"]');
                // address_textが存在しない場合のフォールバックとしてaddressも考慮
                const addressInput = form.querySelector('input[name="address_text"]') || form.querySelector('input[name="address"]');

                if (zipInputForApi && stateInput && cityInput && addressInput) {
                    zipInputForApi.addEventListener("blur", function () {
                        // 全角数字を半角数字に変換し、ハイフンを消す
                        const zipValue = this.value
                            .replace(/[Ａ-Ｚａ-ｚ０-９]/g, (s) =>
                                String.fromCharCode(s.charCodeAt(0) - 0xfee0),
                            )
                            .replace(/[^0-9]/g, "");
                        
                        // バリデーション用ロジックとは独立して値をセット（UX向上）
                        // ただし、バリデーションロジックはinputイベントで発火するため、
                        // ここで値を書き換えた場合は別途inputイベントを発火させたほうが親切だが、
                        // HubSpotのフィールド制御と競合しないよう、ここでは値の整形とAPIコールに留める。

                        if (!zipValue || isNaN(zipValue)) {
                            // API処理としては警告を出して終了（バリデーションエラーは既存ロジックが担当）
                            console.warn("郵便番号が正しくありません");
                            return;
                        } else if (zipValue.length !== 7) {
                            console.warn("郵便番号の桁数が正しくありません");
                            return;
                        }
                        console.log("⭐️⭐️⭐️⭐️⭐️zipValue",zipValue)

                        const callbackName = "zipcloud_callback_" + zipValue;

                        // コールバック関数定義
                        window[callbackName] = function (addr) {
                            const updateZipCodeField = (data) => {
                                // 値をセット
                                // ZipCloud: address1=都道府県, address2=市区町村, address3=町域
                                stateInput.value = data.address1 || "";
                                cityInput.value = data.address2 || "";
                                addressInput.value = data.address3 || "";

                                // HubSpotに通知（イベント発火）
                                // React等の仮想DOMが変更を検知するために必要
                                [stateInput, cityInput, addressInput].forEach((field) => {
                                    field.dispatchEvent(
                                        new Event("input", { bubbles: true, cancelable: true }),
                                    );
                                    field.dispatchEvent(
                                        new Event("change", { bubbles: true, cancelable: true }),
                                    );
                                });
                            };

                            if (addr && addr.results && addr.results.length > 0) {
                                console.log("⭐️⭐️⭐️⭐️⭐️⭐️addr", addr);
                                switch (addr.results.length) {
                                    case 0:
                                        console.warn("該当する住所が見つかりませんでした。");
                                        break;

                                    case 1:
                                        updateZipCodeField(addr.results[0]);
                                        break;

                                    default:
                                        // 複数件ヒット時のポップアップ処理
                                        const overlay = document.createElement("div");
                                        overlay.className = "zipcloud-overlay";

                                        // オーバーレイ削除と、ESCキー監視の解除を同時に行います
                                        const closeModal = () => {
                                            if (overlay.parentNode) {
                                                document.body.removeChild(overlay);
                                            }
                                            document.removeEventListener("keydown", onEscKey);
                                        };

                                        // --- ESCキーで閉じる ---
                                        const onEscKey = (e) => {
                                            if (e.key === "Escape") {
                                                e.preventDefault();
                                                closeModal();
                                            }
                                        };
                                        document.addEventListener("keydown", onEscKey);

                                        // --- オーバーレイ（外側）クリックで閉じる ---
                                        overlay.onclick = (e) => {
                                            if (e.target === overlay) {
                                                e.preventDefault();
                                                closeModal();
                                            }
                                        };

                                        // モーダル本体
                                        const modal = document.createElement("div");
                                        modal.className = "zipcloud-modal";

                                        modal.innerHTML =
                                            '<h3 class="zipcloud-title">以下の住所から選択してください</h3>';

                                        const fragment = document.createDocumentFragment();

                                        // ボタン生成ループ
                                        addr.results.forEach((result) => {
                                            const btn = document.createElement("button");
                                            btn.textContent =
                                                result.address1 + result.address2 + result.address3;

                                            btn.className = "zipcloud-btn";

                                            // クリックイベント
                                            btn.onclick = (e) => {
                                                e.preventDefault();
                                                updateZipCodeField(result);
                                                closeModal();
                                            };
                                            fragment.appendChild(btn);
                                        });

                                        modal.appendChild(fragment);

                                        // キャンセルボタン
                                        const closeBtn = document.createElement("button");
                                        closeBtn.textContent = "キャンセル";
                                        closeBtn.className = "zipcloud-cancel-btn";

                                        closeBtn.onclick = (e) => {
                                            e.preventDefault();
                                            closeModal();
                                        };
                                        modal.appendChild(closeBtn);

                                        overlay.appendChild(modal);
                                        document.body.appendChild(overlay);

                                        // モーダル内の最初のボタンにフォーカスを当てる（アクセシビリティ向上）
                                        setTimeout(() => {
                                            const firstBtn = modal.querySelector('button');
                                            if (firstBtn) firstBtn.focus();
                                        }, 10);
                                        break;
                                }
                            } else {
                                console.warn("ZipCloud: 該当なし。該当する住所が見つかりませんでした。", addr);
                            }

                            // クリーンアップ
                            document.body.removeChild(scriptTag);
                            delete window[callbackName];
                        };

                        // APIリクエスト
                        const scriptTag = document.createElement("script");
                        scriptTag.src =
                            "https://zipcloud.ibsnet.co.jp/api/search?zipcode=" +
                            zipValue +
                            "&callback=" +
                            callbackName;

                        scriptTag.onerror = function () {
                            console.error("API_ERROR: リクエスト失敗");
                            document.body.removeChild(scriptTag);
                            delete window[callbackName];
                        };
                        document.body.appendChild(scriptTag);
                    });
                }
            }

            // クッキーを取得する関数
            function getCookie(name) {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith(name + "=")) {
                        return cookie.substring(name.length + 1);
                    }
                }
                return null; // クッキーが見つからない場合はnullを返す
            }

            // _fbp と _fbc の値を取得してフォームにセットする
            function setFbpAndFbc() {
                console.log("クッキー情報: ", document.cookie); // クッキーの確認

                let fbp = getCookie("_fbp") || localStorage.getItem("_fbp"); // クッキー or ローカルストレージから取得
                let fbc = getCookie("_fbc") || localStorage.getItem("_fbc");

                console.log("_fbp:", fbp, "_fbc:", fbc); // 値の確認

                // _fbpが取得できない場合は、Facebook Pixelをトリガーして取得を試みる
                if (!fbp && window.fbq) {
                    console.log("fbpが取得できないため、Facebook Pixelを実行");
                    fbq('track', 'PageView'); // 強制的にピクセルイベントをトリガー
                    setTimeout(() => {
                        fbp = getCookie("_fbp");
                        if (fbp) {
                            localStorage.setItem("_fbp", fbp); // ローカルストレージに保存
                        }
                    }, 2000); // 2秒遅延して取得
                }

                // フォーム要素が存在するかチェック
                setTimeout(() => {
                    let fbpInput = document.querySelector("input[name*=browser_id_fbp_capi]");
                    let fbcInput = document.querySelector("input[name*=click_id_fbc_capi]");

                    if (fbp && fbpInput) {
                        fbpInput.value = fbp;
                    }
                    if (fbc && fbcInput) {
                        fbcInput.value = fbc;
                    }
                }, 1000); // 1秒遅延させてフォームのロードを待つ
            }

            // 実行
            setFbpAndFbc();
        }
        if(event.data.type === 'hsFormCallback' && event.data.eventName === 'onFormSubmitted') {
            window.location = '/contacts/document/thanks#application';
        }
    }, false);
</script>
{% endblock body %}
{% block footer %}
{% global_partial path="../templates/partials/footer-2025.html" %}
{% endblock footer %}
