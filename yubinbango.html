<!--
  templateType: page
  isAvailableForNewContent: true
  label: Yubinbango
  screenshotPath: ../images/template-previews/home.png
-->
{% extends "./layouts/base.html" %}

{% block body %}

{# All templates are recommended to have an h1 present for both accessibility and SEO best practice. This should be at the top of the template before any other textual content. The h1 element below is within a dnd area to allow content editors the ability to adjust the content and alignment of the text. #}

{#
<form class="h-adr">
    <span class="p-country-name" style="display:none;">Japan</span>
    〒
    <input
        type="text"
        class="p-postal-code"
        size="8"
        maxlength="8"
    >
    <input type="text" class="p-region p-locality p-street-address p-extended-address">
</form>
#}
{% dnd_area "dnd_area"
  label="Main section",
  class="body-container body-container--home"
%}


{# Hero banner #}

{% include_dnd_partial path="../sections/hero-banner.html" %}

{# Two column image right #}

{% include_dnd_partial path="../sections/multi-row-content.html" %}

{# Two column image left #}

{% dnd_section
    background_color="#f8fafc",
    vertical_alignment="MIDDLE"
  %}
{% dnd_module
      path="@hubspot/linked_image",
      img={
        "alt": "Stock placeholder image with grayscale geometrical mountain landscape",
        "loading": "lazy",
        "max_height": 451,
        "max_width": 605,
        "size_type": "auto_custom_max",
        "src": get_asset_url("../images/grayscale-mountain.png")
      },
      offset=0,
      width=6
    %}
{% end_dnd_module %}
{% dnd_module
      path="@hubspot/rich_text",
      html="
<h2>Provide more details here.</h2>
<p>Use text and images to tell your company’s story. Explain what makes your product or service extraordinary.</p>
"
      offset=6,
      width=6
    %}
{% end_dnd_module %}
{% end_dnd_section %}

{# Call to action #}

{% include_dnd_partial path="../sections/call-to-action.html" %}

{# Three column image with text #}

{% include_dnd_partial path="../sections/multi-column-content.html" %}

{% end_dnd_area %}
<style>
  /* モーダルの背景（オーバーレイ） */
  .zipcloud-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* モーダル本体 */
  .zipcloud-modal {
    background-color: #fff;
    padding: 24px;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    text-align: left;
  }

  /* 見出し */
  .zipcloud-title {
    margin: 0 0 16px 0;
    font-size: 18px;
    text-align: center;
    color: #333;
    font-weight: bold;
  }

  /* 住所選択ボタン */
  .zipcloud-btn {
    display: block;
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    text-align: left;
    font-size: 14px;
    color: #495057;
    transition: background-color 0.2s;
  }

  /* 住所選択ボタン：ホバー時 */
  .zipcloud-btn:hover {
    background-color: #e9ecef;
  }

  /* キャンセルボタン */
  .zipcloud-cancel-btn {
    margin-top: 16px;
    padding: 8px 16px;
    cursor: pointer;
    background-color: transparent;
    color: #666;
    border: none;
    display: block;
    width: 100%;
    text-decoration: underline;
  }

  .zipcloud-cancel-btn:hover {
    color: #333;
  }
</style>
<script>
  /**
   * 1. HubSpotフォームが読み込まれた時の処理
   */
  window.addEventListener("message", (event) => {
    if (
      event.data.type === "hsFormCallback" &&
      event.data.eventName === "onFormReady"
    ) {
      const formId = event.data.id;
      const form = document.querySelector(
        'form[data-form-id="' + formId + '"]',
      );

      if (form) {
        const zipInput = form.querySelector('input[name="zip"]');
        const stateInput = form.querySelector('input[name="state"]');
        const cityInput = form.querySelector('input[name="city"]');
        const addressInput = form.querySelector('input[name="address_text"]');

        if (zipInput && stateInput && cityInput && addressInput) {
          zipInput.addEventListener("blur", function () {
            // 全角数字を半角数字に変換し、ハイフンを消す
            const zipValue = this.value
              .replace(/[Ａ-Ｚａ-ｚ０-９]/g, (s) =>
                String.fromCharCode(s.charCodeAt(0) - 0xfee0),
              )
              .replace(/[^0-9]/g, "");
            this.value = zipValue;

            if (!zipValue || isNaN(zipValue)) {
              console.warn("郵便番号が正しくありません");
              return;
            } else if (zipValue.length !== 7) {
              console.warn("郵便番号の桁数が正しくありません");
              return;
            }

            const callbackName = "zipcloud_callback_" + zipValue;

            window[callbackName] = function (addr) {
              const updateZipCodeField = (data) => {
                // 値をセット
                stateInput.value = data.address1 || "";
                cityInput.value = data.address2 || "";
                addressInput.value = data.address3 || "";

                // HubSpotに通知（イベント発火）
                [stateInput, cityInput, addressInput].forEach((field) => {
                  field.dispatchEvent(
                    new Event("input", { bubbles: true, cancelable: true }),
                  );
                  field.dispatchEvent(
                    new Event("change", { bubbles: true, cancelable: true }),
                  );
                });
              };

              if (addr && addr.results && addr.results.length > 0) {
                switch (addr.results.length) {
                  case 0:
                    console.warn("該当する住所が見つかりませんでした。");
                    return;
                    break;

                  case 1:
                    updateZipCodeField(addr.results[0]);
                    break;

                  default:
                    // 複数件ヒット時のポップアップ処理
                    const overlay = document.createElement("div");
                    overlay.className = "zipcloud-overlay";

                    // モーダル
                    const modal = document.createElement("div");
                    modal.className = "zipcloud-modal";

                    modal.innerHTML =
                      '<h3 style="margin:0 0 16px 0; font-size:18px; text-align:center; color:#333;">以下の住所から選択してください</h3>';

                    const fragment = document.createDocumentFragment();

                    // ボタン生成ループ
                    addr.results.forEach((result) => {
                      const btn = document.createElement("button");
                      btn.textContent =
                        result.address1 + result.address2 + result.address3;

                      btn.className = "zipcloud-btn";

                      // クリックイベント
                      btn.onclick = (e) => {
                        e.preventDefault();
                        updateZipCodeField(result);
                        document.body.removeChild(overlay);
                      };
                      fragment.appendChild(btn);
                    });

                    modal.appendChild(fragment);

                    // キャンセルボタン
                    const closeBtn = document.createElement("button");
                    closeBtn.textContent = "キャンセル";
                    closeBtn.className = "zipcloud-cancel-btn";

                    closeBtn.onclick = (e) => {
                      e.preventDefault();
                      document.body.removeChild(overlay);
                    };
                    modal.appendChild(closeBtn);

                    overlay.appendChild(modal);
                    document.body.appendChild(overlay);
                    break;
                }
              } else {
                console.warn("ZipCloud: 該当なし", addr);
                console.warn("該当する住所が見つかりませんでした。");
                return;
              }

              // クリーンアップ
              document.body.removeChild(scriptTag);
              delete window[callbackName];
            };

            // APIリクエスト
            const scriptTag = document.createElement("script");
            scriptTag.src =
              "https://zipcloud.ibsnet.co.jp/api/search?zipcode=" +
              zipValue +
              "&callback=" +
              callbackName;

            scriptTag.onerror = function () {
              console.error("API_ERROR: リクエスト失敗");
              document.body.removeChild(scriptTag);
              delete window[callbackName];
            };
            document.body.appendChild(scriptTag);
          });
        } else {
          console.error("入力フィールド不足");
        }
      }
    }
  });
</script>
{% endblock body %}
